import requests
import json
import time

BASE_URL = "http://127.0.0.1:8003"

def test_full_workflow():
    print("=== Testing Full Product & Order Workflow ===")
    
    # Step 1: Create a new product
    print("\n1. Creating a new product...")
    new_product = {
        "name": "Integration Test Product",
        "description": "A product created during integration testing",
        "price": "199.99"
    }
    
    response = requests.post(f"{BASE_URL}/products", json=new_product)
    if response.status_code == 200:
        created_product = response.json()
        product_id = created_product["id"]
        print(f"✅ Product created successfully with ID: {product_id}")
        print(f"   Name: {created_product['name']}")
        print(f"   Price: ${created_product['price']}")
        print(f"   Created at: {created_product['created_at']}")
    else:
        print(f"❌ Failed to create product: {response.text}")
        return
    
    # Step 2: Verify product appears in product list
    print(f"\n2. Verifying product appears in product list...")
    response = requests.get(f"{BASE_URL}/products")
    if response.status_code == 200:
        products = response.json()\n        found_product = next((p for p in products if p['id'] == product_id), None)\n        if found_product:\n            print(f\"✅ Product found in list (Total products: {len(products)})\")\n        else:\n            print(\"❌ Product not found in list\")\n            return\n    else:\n        print(f\"❌ Failed to get products: {response.text}\")\n        return\n    \n    # Step 3: Get individual product details\n    print(f\"\\n3. Getting individual product details...\")\n    response = requests.get(f\"{BASE_URL}/products/{product_id}\")\n    if response.status_code == 200:\n        product_details = response.json()\n        print(f\"✅ Product details retrieved successfully\")\n        print(f\"   ID: {product_details['id']}\")\n        print(f\"   Name: {product_details['name']}\")\n        print(f\"   Description: {product_details['description']}\")\n        print(f\"   Price: ${product_details['price']}\")\n    else:\n        print(f\"❌ Failed to get product details: {response.text}\")\n        return\n    \n    # Step 4: Create an order with the new product\n    print(f\"\\n4. Creating an order with the new product...\")\n    new_order = {\n        \"customer_name\": \"Integration Test Customer\",\n        \"customer_email\": \"integration@test.com\",\n        \"shipping_address\": \"123 Integration Test St, Test City, TC 12345\",\n        \"total_amount\": \"399.98\",\n        \"items\": [\n            {\n                \"product_id\": product_id,\n                \"quantity\": 2,\n                \"price_at_time\": \"199.99\"\n            }\n        ]\n    }\n    \n    response = requests.post(f\"{BASE_URL}/orders\", json=new_order)\n    if response.status_code == 200:\n        created_order = response.json()\n        order_id = created_order[\"id\"]\n        print(f\"✅ Order created successfully with ID: {order_id}\")\n        print(f\"   Customer: {created_order['customer_name']}\")\n        print(f\"   Total: ${created_order['total_amount']}\")\n        print(f\"   Status: {created_order['status']}\")\n        print(f\"   Order date: {created_order['order_date']}\")\n    else:\n        print(f\"❌ Failed to create order: {response.text}\")\n        return\n    \n    # Step 5: Verify order appears in order list\n    print(f\"\\n5. Verifying order appears in order list...\")\n    response = requests.get(f\"{BASE_URL}/orders\")\n    if response.status_code == 200:\n        orders = response.json()\n        found_order = next((o for o in orders if o['id'] == order_id), None)\n        if found_order:\n            print(f\"✅ Order found in list (Total orders: {len(orders)})\")\n        else:\n            print(\"❌ Order not found in list\")\n            return\n    else:\n        print(f\"❌ Failed to get orders: {response.text}\")\n        return\n    \n    # Step 6: Get individual order details\n    print(f\"\\n6. Getting individual order details...\")\n    response = requests.get(f\"{BASE_URL}/orders/{order_id}\")\n    if response.status_code == 200:\n        order_details = response.json()\n        print(f\"✅ Order details retrieved successfully\")\n        print(f\"   ID: {order_details['id']}\")\n        print(f\"   Customer: {order_details['customer_name']}\")\n        print(f\"   Email: {order_details['customer_email']}\")\n        print(f\"   Items: {len(order_details['items'])} item(s)\")\n        for item in order_details['items']:\n            print(f\"     - Product ID: {item['product_id']}, Quantity: {item['quantity']}, Price: ${item['price_at_time']}\")\n    else:\n        print(f\"❌ Failed to get order details: {response.text}\")\n        return\n    \n    print(f\"\\n✅ Full workflow completed successfully!\")\n    print(f\"   Created Product ID: {product_id}\")\n    print(f\"   Created Order ID: {order_id}\")\n\ndef test_cors_and_connectivity():\n    print(\"\\n=== Testing CORS and Connectivity ===\\n\")\n    \n    # Test basic connectivity\n    print(\"1. Testing basic server connectivity...\")\n    try:\n        response = requests.get(f\"{BASE_URL}/\")\n        if response.status_code == 200:\n            print(\"✅ Server is accessible\")\n            print(f\"   Response: {response.json()}\")\n        else:\n            print(f\"❌ Server responded with status {response.status_code}\")\n    except requests.exceptions.ConnectionError:\n        print(\"❌ Cannot connect to server\")\n        return False\n    \n    # Test CORS headers (simulate browser request)\n    print(\"\\n2. Testing CORS headers...\")\n    headers = {\n        'Origin': 'http://localhost:3000',\n        'Access-Control-Request-Method': 'POST',\n        'Access-Control-Request-Headers': 'Content-Type'\n    }\n    \n    try:\n        response = requests.options(f\"{BASE_URL}/products\", headers=headers)\n        cors_headers = response.headers\n        \n        if 'Access-Control-Allow-Origin' in cors_headers:\n            print(f\"✅ CORS configured - Allow-Origin: {cors_headers.get('Access-Control-Allow-Origin')}\")\n        else:\n            print(\"⚠️  CORS headers not found (may still work)\")\n            \n        if 'Access-Control-Allow-Methods' in cors_headers:\n            print(f\"   Allow-Methods: {cors_headers.get('Access-Control-Allow-Methods')}\")\n            \n    except Exception as e:\n        print(f\"⚠️  CORS test failed: {e}\")\n    \n    return True\n\nif __name__ == \"__main__\":\n    print(\"Starting Full Integration Tests...\")\n    print(\"Make sure your FastAPI server is running on http://127.0.0.1:8003\")\n    print(\"This test will create a product and order to verify the full workflow.\")\n    \n    if test_cors_and_connectivity():\n        test_full_workflow()\n        \n        print(\"\\n=== Integration Test Summary ===\")\n        print(\"✅ All integration tests completed!\")\n        print(\"\\nYour backend is ready for frontend integration.\")\n        print(\"\\nTo test with your React frontend:\")\n        print(\"1. Start your FastAPI server: python server.py\")\n        print(\"2. Start your React app: npm start\")\n        print(\"3. Navigate to http://localhost:3000\")\n        print(\"4. Test creating products and orders through the UI\")\n    else:\n        print(\"\\n❌ Basic connectivity failed. Please check your server.\")